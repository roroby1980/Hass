- id: 'Awway Mode'
  alias: Switch all off if we are away
  trigger:
    platform: state
    entity_id: group.family
    from: home
  action:
    - service: light.turn_off
      entity_id: group.all_lights
    - service: switch.turn_off
      entity_id: 
        - switch.sonoff
        - switch.tasmota
    - service: climate.set_temperature
      data:
        entity_id: climate.riscaldamento
        temperature: 15

- id: 'Home Mode'
  alias: all on on come back
  trigger:
    platform: state
    entity_id: group.family
    to: home
  action:
    - service: climate.set_temperature
      data:
        entity_id: climate.riscaldamento
        temperature: 15


- id: 'Away Mode no phone info'
  alias: Away Mode no phone info
  trigger:
    platform: state
    entity_id: group.inside_presences
    to: 'off'
    for:
      minutes: 45
  condition:
    - condition: template
      value_template: "{{ ((as_timestamp(now()) - as_timestamp(as_timestamp(states.sensor.geocoded_location.last_updated) |timestamp_local)) /3600) |round > 12 }}"
    - condition: time
      after: '07:00:00'
      before: '22:00:00'
    - condition: state
      entity_id: group.family
      state: home 
  action:
    - service: light.turn_off
      entity_id: group.all_lights
    - service: switch.turn_off
      entity_id: 
        - switch.sonoff
        - switch.tasmota
    - service: climate.set_temperature
      data:
        entity_id: climate.riscaldamento
        temperature: 15
    - service: notify.mobile_app_iphone_di_roberto
      data_template:
        title: Away Mode while no phone info
        message: 'No motion detected in house, last update phone at: {{ as_timestamp(states.sensor.geocoded_location.last_updated) |timestamp_local }}
         Away mode set now : {{ now().strftime("%H:%M:%S") }}'