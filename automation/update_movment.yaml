#HOME MOVMENT
- id: 'Mov1'
  alias: update last movment entrance
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.ma_3
    to: 'on'
  action:
  - service: var.set
    data:
      entity_id: var.last_movment_entrance
      value_template: '{{ now().strftime("%H:%M:%S") }}'

- id: 'Mov7'
  alias: update last movment bathroom
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.m_bathroom
    to: 'on'
  action:
  - service: var.set
    data:
      entity_id: var.last_movment_bathroom
      value_template: '{{ now().strftime("%H:%M:%S") }}'
      
#BALCONY MOVMENT      

- id: 'Mov10'
  alias: update last movment balcony south
  trigger:
  - platform: state
    entity_id: binary_sensor.m_dressing
    to: 'on'
  action:
  - service: var.set
    data:
      entity_id: var.last_movment_balcony_south
      value_template: '{{ now().strftime("%H:%M:%S") }}'
      
- id: 'Mov11'
  alias: update last movment balcony east
  trigger:
  - platform: state
    entity_id: binary_sensor.ma_one
    to: 'on'
  action:
  - service: var.set
    data:
      entity_id: var.last_movment_balcony_east
      value_template: '{{ now().strftime("%H:%M:%S") }}'
      
- id: 'Mov12'
  alias: update last movment balcony west
  trigger:
  - platform: state
    entity_id: binary_sensor.ma_2
    to: 'on'
  action:
  - service: var.set
    data:
      entity_id: var.last_movment_balcony_west
      value_template: '{{ now().strftime("%H:%M:%S") }}'

#WINDOWS LIVINGROOM

- id: 'Mov2'
  alias: update last open window livingroom
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.w_livingroom
    to: 'on'
  action:
  - service: var.set
    data:
      entity_id: var.last_open_livingroom_window
      value_template: '{{ now().strftime("%H:%M:%S") }}'
      
- id: 'Mov3'
  alias: update last open window livingroom (datetime)
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.w_livingroom
    to: 'on'
  action:
  - service: input_datetime.set_datetime
    data_template:
      entity_id: input_datetime.livingroom_open
      datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
    
- id: 'Mov4'
  alias: update last close window livingroom (datetime)
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.w_livingroom
    to: 'off'
  action:
  - service: input_datetime.set_datetime
    data_template:
      entity_id: input_datetime.livingroom_close
      datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

- id: 'Mov5'
  alias: set time of windows livingroom was open
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.w_livingroom
    to: 'off'
  action:
  - delay: '00:00:03'
  - service: input_datetime.set_datetime
    data_template:
      entity_id: input_datetime.livingroom_lasttime
      time: "{{ (as_timestamp(states.input_datetime.livingroom_close.state) - as_timestamp(states.input_datetime.livingroom_open.state)) | timestamp_custom('%H:%M:%S', false) }}"

- id: 'Mov6'
  alias: 'Update Last open Time'
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.w_livingroom
    to: 'off'
  action:
  - delay: '00:00:05'
  - service: var.set
    data:
      entity_id: var.time_open_livingroom_window
      value_template: '{{ states.input_datetime.livingroom_lasttime.state }}'


#PHONE UPDATE
      
- id: 'Mov8'
  alias: Aggiorna Ultima posizione Tami
  trigger:
  - platform: state
    entity_id: sensor.geocoded_location
  action:
  - service: var.set
    data:
      entity_id: var.ultimo_aggiornamento_tami_phone
      value_template: '{{ now().strftime("%H:%M:%S") }}'
      
- id: 'Mov9'
  alias: Aggiorna Ultima posizione Roby
  trigger:
  - platform: state
    entity_id: sensor.geocoded_location_2
  action:
  - service: var.set
    data:
      entity_id: var.ultimo_aggiornamento_roby_phone
      value_template: '{{ now().strftime("%H:%M:%S") }}'
      

      
- id: 'Mov13'
  alias: update last movment yicam
  trigger:
  - platform: state
    entity_id:
    - sensor.yicam
    to: 'motion_start'
  action:
  - service: var.set
    data:
      entity_id: var.last_movment_yicam
      value_template: '{{ now().strftime("%H:%M:%S") }}'


- id: 'Mov14'
  alias: reset orari last movment
  trigger:
    platform: time
    at: "00:00:00"
  action:
  - service: var.set
    data:
      entity_id: 
      - var.last_movment_balcony_west
      - var.last_movment_balcony_east
      - var.last_movment_balcony_south
      - var.ultimo_movimento
      value_template: '{{ now().strftime("%H:%M:%S") }}'